# Dockerfile for Video Processor Lambda Function
# Uses AWS Lambda Python base image for compatibility

FROM public.ecr.aws/lambda/python:3.11

# Ensure /usr/local/bin is in PATH for ffmpeg/ffprobe
ENV PATH="/usr/local/bin:${PATH}"

# Install system dependencies required for video/audio processing
# Install build tools for compiling Python packages and tools for ffmpeg extraction
RUN yum update -y && \
    yum install -y \
    gcc \
    gcc-c++ \
    make \
    git \
    curl \
    tar \
    xz \
    python3-devel \
    && yum clean all \
    && rm -rf /var/cache/yum || true

# Copy requirements first for better layer caching
COPY requirements.txt ${LAMBDA_TASK_ROOT}/

# Install Python dependencies
# Note: Lambda base image has /var/task as the working directory
# Use set -e to fail on any error
RUN set -e && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# Install core dependencies with pinned versions (pre-built wheels only)
# Pin versions that have pre-built wheels for Lambda's architecture
RUN set -e && \
    pip install --no-cache-dir \
    "pydantic==2.5.3" \
    "pydantic-settings==2.1.0" \
    "python-dotenv==1.0.0" \
    "boto3==1.34.0" \
    "numpy==1.24.3" \
    "Pillow==10.2.0" \
    "click==8.1.7" \
    "tqdm==4.66.1"

# Install LLM and API dependencies
RUN set -e && \
    pip install --no-cache-dir \
    "openai==1.12.0" \
    "pinecone==5.0.1"

# Install media processing dependencies
# Note: FFmpeg, PyTorch, Whisper, etc. are large - install selectively
# Install librosa for diarization (required for pyannote.audio workaround)
# Install opencv and scipy for scenedetect (scenedetect requires cv2 import)
RUN set -e && \
    pip install --no-cache-dir \
    "opencv-python-headless>=4.8.0" \
    "librosa>=0.10.0" \
    "soundfile>=0.12.1" \
    "scipy>=1.10.0" && \
    python -c "import cv2; print(f'✅ opencv-python-headless {cv2.__version__} installed')" && \
    python -c "import librosa; print('✅ librosa installed')" || echo "⚠️ librosa installation failed (diarization may use fallback)"

# Install scenedetect (opencv and scipy already installed above)
# Must be in same RUN or verify cv2 is importable
RUN set -e && \
    python -c "import cv2; print('Verifying cv2 available for scenedetect...')" && \
    pip install --no-cache-dir "scenedetect==0.6.2" && \
    python -c "import scenedetect; from scenedetect import VideoManager, SceneManager; from scenedetect.detectors import ContentDetector; print('✅ scenedetect installed and importable')" || \
    (echo "⚠️ scenedetect installation/import failed, trying alternative..." && \
     pip install --no-cache-dir "scenedetect[opencv-headless]==0.6.2" && \
     python -c "import scenedetect; print('✅ scenedetect installed (with extras)')" || \
     echo "⚠️ scenedetect installation failed completely")

# Install PyTorch (CPU version for Lambda) - REQUIRED for audio processing
# Using CPU-only version to reduce size and avoid CUDA dependencies
RUN set -e && \
    pip install --no-cache-dir \
    "torch==2.1.2" \
    "torchaudio==2.1.2" \
    --index-url https://download.pytorch.org/whl/cpu && \
    python -c "import torch; print(f'✅ torch {torch.__version__} installed')" && \
    python -c "import torchaudio; print(f'✅ torchaudio {torchaudio.__version__} installed')"

# Install pyannote.audio - REQUIRED for speaker diarization
# Must be installed after torch
# Note: pyannote.core 5.x+ requires numpy 2.x (needs GCC >= 9.3)
# Install einops and huggingface_hub (required by pyannote.audio), then try to install pyannote.core 4.x
# pyannote.core 4.x should work with numpy 1.24.3
RUN set -e && \
    pip install --no-cache-dir "einops>=0.6.0" \
    "huggingface-hub>=0.20.0" && \
    pip install --no-cache-dir "pyannote.audio==3.1.1" --no-deps && \
    (pip install --no-cache-dir "pyannote.core==4.5.1" --no-deps && \
     pip install --no-cache-dir "numpy==1.24.3" "typing-extensions" "sortedcontainers" || \
     pip install --no-cache-dir "pyannote.core==4.4.1" --no-deps && \
     pip install --no-cache-dir "numpy==1.24.3" "typing-extensions" "sortedcontainers" || \
     pip install --no-cache-dir "pyannote.core==4.4.0" --no-deps && \
     pip install --no-cache-dir "numpy==1.24.3" "typing-extensions" "sortedcontainers" || \
     echo "Warning: pyannote.core installation failed - diarization will be skipped") && \
    pip install --no-cache-dir \
    "rich>=12.0.0" \
    "semver>=3.0.0" \
    "soundfile>=0.12.1" \
    "tensorboardX>=2.6" \
    "pytorch-lightning>=2.0.0,<3.0.0" && \
    echo "Note: pyannote.database, pyannote.metrics, pyannote.pipeline, asteroid-filterbanks, speechbrain, and pytorch-metric-learning skipped (require numpy 2.x)" && \
    python -c "import torch; print('✅ torch installed')" && \
    python -c "import einops; print('✅ einops installed')" && \
    (python -c "import pyannote.audio; print('✅ pyannote.audio installed')" || echo "⚠️ pyannote.audio import may fail without full dependencies")

# Install OpenAI Whisper (required for ASR)
# Install tiktoken first (required by whisper), then whisper
# Note: tiktoken may need to be built from source, but we'll try pre-built wheels first
RUN set -e && \
    (pip install --no-cache-dir "tiktoken>=0.5.0" || \
     pip install --no-cache-dir "tiktoken==0.5.0" || \
     echo "Warning: tiktoken installation failed") && \
    (pip install --no-cache-dir "openai-whisper==20231117" && \
     python -c "import whisper; print('✅ whisper installed')" || \
     (echo "Warning: whisper installation failed (ASR will be skipped)" && \
      pip install --no-cache-dir "openai-whisper==20231117" --no-deps || echo "whisper --no-deps also failed"))

# Install FFmpeg (static linux amd64 build) and verify
RUN set -e && \
    curl -L "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" -o /tmp/ffmpeg-static.tar.xz && \
    mkdir -p /tmp/ffmpeg-static && \
    tar -xJf /tmp/ffmpeg-static.tar.xz -C /tmp/ffmpeg-static --strip-components=1 && \
    cp /tmp/ffmpeg-static/ffmpeg /usr/local/bin/ffmpeg && \
    cp /tmp/ffmpeg-static/ffprobe /usr/local/bin/ffprobe && \
    chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe && \
    ffmpeg -version && \
    ffprobe -version && \
    echo "✅ FFmpeg and ffprobe installed successfully"

# Verify critical Python dependencies are installed
RUN set -e && \
    python -c "import pydantic; print('✅ pydantic OK')" && \
    python -c "import boto3; print('✅ boto3 OK')" && \
    python -c "import numpy; print('✅ numpy OK')" && \
    python -c "import openai; print('✅ openai OK')" && \
    python -c "import pinecone; print('✅ pinecone OK')" && \
    python -c "import torch; print(f'✅ torch {torch.__version__} OK')" && \
    (python -c "import pyannote.audio; print('✅ pyannote.audio OK')" || echo "⚠️ pyannote.audio not fully available (some features may not work)") && \
    (python -c "import pytorch_lightning; print('✅ pytorch_lightning OK')" || echo "⚠️ pytorch_lightning not available") && \
    (python -c "import scenedetect; print('✅ scenedetect OK')" || echo "⚠️ scenedetect not available") && \
    (python -c "import whisper; print('✅ whisper OK')" || echo "⚠️ whisper not available") && \
    echo "✅ Critical Python dependencies verified (torch is working)"

# Copy application code
COPY src/ ${LAMBDA_TASK_ROOT}/src/
COPY config/ ${LAMBDA_TASK_ROOT}/config/

# Create lambda handler entry point
# The handler function is in src/workers/lambda_handler.py
# AWS Lambda will look for lambda_function.lambda_handler by default
COPY lambda_handler_processor.py ${LAMBDA_TASK_ROOT}/lambda_function.py

# Verify processor import works (catches circular imports)
RUN set -e && \
    python -c "from lambda_function import lambda_handler; print('processor import ok')" && \
    echo "✅ Processor import verified successfully"

# Set the CMD to your handler (AWS Lambda base image expects this format)
CMD [ "lambda_function.lambda_handler" ]
