# Dockerfile for Video Processor Lambda Function
# Uses AWS Lambda Python base image for compatibility

FROM public.ecr.aws/lambda/python:3.11

# Ensure /usr/local/bin is in PATH for ffmpeg/ffprobe
ENV PATH="/usr/local/bin:${PATH}"

# Install system dependencies required for video/audio processing
# Install build tools for compiling Python packages and tools for ffmpeg extraction
RUN yum update -y && \
    yum install -y \
    gcc \
    gcc-c++ \
    make \
    git \
    curl \
    tar \
    xz \
    python3-devel \
    && yum clean all \
    && rm -rf /var/cache/yum || true

# Copy requirements first for better layer caching
COPY requirements.txt ${LAMBDA_TASK_ROOT}/

# Install Python dependencies
# Note: Lambda base image has /var/task as the working directory
# Use set -e to fail on any error
RUN set -e && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# Install core dependencies with pinned versions (pre-built wheels only)
# Install scipy EARLY with pre-built wheel (required by pyannote.audio and scenedetect)
# Pin versions that have pre-built wheels for Lambda's architecture
RUN set -e && \
    pip install --no-cache-dir \
    "pydantic==2.5.3" \
    "pydantic-settings==2.1.0" \
    "python-dotenv==1.0.0" \
    "boto3==1.34.0" \
    "numpy==1.24.3" \
    "scipy==1.11.4" \
    "Pillow==10.2.0" \
    "click==8.1.7" \
    "tqdm==4.66.1" && \
    python -c "import scipy; print(f'✅ scipy {scipy.__version__} installed')"

# Install LLM and API dependencies
RUN set -e && \
    pip install --no-cache-dir \
    "openai==1.12.0" \
    "pinecone==5.0.1"

# Install media processing dependencies (opencv, librosa, scenedetect)
# scipy already installed above - opencv and scenedetect need it
# Use opencv-python-headless for Lambda (no GUI dependencies like libGL.so.1)
# Install librosa without optional dependencies to avoid scikit-learn build issues
# Install in single RUN to ensure all dependencies available together
RUN set -e && \
    pip install --no-cache-dir \
    "opencv-python-headless==4.9.0.80" \
    "soundfile>=0.12.1" && \
    python -c "import cv2; print(f'✅ opencv-python-headless {cv2.__version__} installed')" && \
    (pip install --no-cache-dir "librosa>=0.10.0" --no-deps && \
     pip install --no-cache-dir "audioread>=2.1.9" "numba>=0.51.0" "packaging>=20.0" "scipy>=1.6.0" "numpy>=1.21.2" || \
     pip install --no-cache-dir "librosa>=0.10.0") && \
    pip install --no-cache-dir "scenedetect==0.6.2" && \
    python -c "import scipy; import cv2; import scenedetect; from scenedetect import VideoManager; print('✅ scenedetect installed and importable')" && \
    python -c "import librosa; print('✅ librosa installed')" || echo "⚠️ librosa installation failed (diarization may use fallback)"

# Install PyTorch (CPU version for Lambda) - REQUIRED for audio processing
# Using CPU-only version to reduce size and avoid CUDA dependencies
RUN set -e && \
    pip install --no-cache-dir \
    "torch==2.1.2" \
    "torchaudio==2.1.2" \
    --index-url https://download.pytorch.org/whl/cpu && \
    python -c "import torch; print(f'✅ torch {torch.__version__} installed')" && \
    python -c "import torchaudio; print(f'✅ torchaudio {torchaudio.__version__} installed')"

# Install pyannote.audio - REQUIRED for speaker diarization
# Must be installed after torch AND scipy (scipy already installed above)
# Note: pyannote.core 5.x+ requires numpy 2.x (needs GCC >= 9.3)
# Install einops, huggingface_hub, and pytorch-lightning first, then pyannote.audio
# pyannote.core 4.x should work with numpy 1.24.3 and scipy 1.11.4
RUN set -e && \
    pip install --no-cache-dir \
    "einops>=0.6.0" \
    "huggingface-hub>=0.16.4,<0.20.0" \
    "pytorch-lightning>=2.0.0,<3.0.0" \
    "rich>=12.0.0" \
    "semver>=3.0.0" \
    "tensorboardX>=2.6" \
    "lazy_loader>=0.3" && \
    pip install --no-cache-dir "pyannote.audio==3.1.1" --no-deps && \
    pip install --no-cache-dir "pyannote.pipeline" --no-deps && \
    pip install --no-cache-dir "optuna<4.0.0" && \
    pip install --no-cache-dir "torch-audiomentations" && \
    (pip install --no-cache-dir "pyannote.core==4.5" --no-deps && \
     pip install --no-cache-dir "typing-extensions" "sortedcontainers" || \
     pip install --no-cache-dir "pyannote.core==4.4" --no-deps && \
     pip install --no-cache-dir "typing-extensions" "sortedcontainers" || \
     pip install --no-cache-dir "pyannote.core==4.3" --no-deps && \
     pip install --no-cache-dir "typing-extensions" "sortedcontainers" || \
     echo "Warning: pyannote.core installation failed - diarization will be skipped") && \
    pip install --no-cache-dir "pandas<2.0.0" && \
    pip install --no-cache-dir "pyannote.database==4.1.1" --no-deps && \
    (pip install --no-cache-dir "pyannote.metrics>=3.2.0,<4.0.0" --no-deps && \
     pip install --no-cache-dir "scipy>=1.6.0" "numpy>=1.21.2" "typing-extensions" || \
     pip install --no-cache-dir "pyannote.metrics==3.3.0" --no-deps && \
     pip install --no-cache-dir "scipy>=1.6.0" "numpy>=1.21.2" "typing-extensions" || \
     pip install --no-cache-dir "pyannote.metrics==3.2.0" --no-deps && \
     pip install --no-cache-dir "scipy>=1.6.0" "numpy>=1.21.2" "typing-extensions" || \
     echo "Warning: pyannote.metrics installation failed - may cause import errors") && \
    pip install --no-cache-dir "pyYAML>=3.12" && \
    python -c "import pyannote.database; print('✅ pyannote.database installed and importable')" && \
    (python -c "import pyannote.metrics; print('✅ pyannote.metrics installed and importable')" || echo "⚠️ pyannote.metrics not importable (may be OK if not used)") && \
    python -c "import scipy; import torch; print('✅ scipy and torch available for pyannote')" && \
    python -c "import einops; print('✅ einops installed')" && \
    python -c "import pytorch_lightning; print('✅ pytorch_lightning installed')" && \
    python -c "from pyannote.audio import Pipeline; print('✅ pyannote.audio Pipeline importable')" && \
    python -c "import pyannote.audio; print('✅ pyannote.audio installed and fully functional')"

# Install OpenAI Whisper (required for ASR)
# Install tiktoken first (required by whisper), then whisper
# Note: tiktoken may need to be built from source, but we'll try pre-built wheels first
RUN set -e && \
    (pip install --no-cache-dir "tiktoken>=0.5.0" || \
     pip install --no-cache-dir "tiktoken==0.5.0" || \
     echo "Warning: tiktoken installation failed") && \
    (pip install --no-cache-dir "openai-whisper==20231117" && \
     python -c "import whisper; print('✅ whisper installed')" || \
     (echo "Warning: whisper installation failed (ASR will be skipped)" && \
      pip install --no-cache-dir "openai-whisper==20231117" --no-deps || echo "whisper --no-deps also failed"))

# Install FFmpeg (static linux amd64 build) and verify
RUN set -e && \
    curl -L "https://johnvansickle.com/ffmpeg/releases/ffmpeg-release-amd64-static.tar.xz" -o /tmp/ffmpeg-static.tar.xz && \
    mkdir -p /tmp/ffmpeg-static && \
    tar -xJf /tmp/ffmpeg-static.tar.xz -C /tmp/ffmpeg-static --strip-components=1 && \
    cp /tmp/ffmpeg-static/ffmpeg /usr/local/bin/ffmpeg && \
    cp /tmp/ffmpeg-static/ffprobe /usr/local/bin/ffprobe && \
    chmod +x /usr/local/bin/ffmpeg /usr/local/bin/ffprobe && \
    ffmpeg -version && \
    ffprobe -version && \
    echo "✅ FFmpeg and ffprobe installed successfully"

# Verify critical Python dependencies are installed
# This is a quick verification step - failures are warnings, not errors
RUN set -e && \
    python -c "import pydantic; print('✅ pydantic OK')" && \
    python -c "import boto3; print('✅ boto3 OK')" && \
    python -c "import numpy; print('✅ numpy OK')" && \
    python -c "import scipy; print(f'✅ scipy {scipy.__version__} OK')" && \
    python -c "import openai; print('✅ openai OK')" && \
    python -c "import pinecone; print('✅ pinecone OK')" && \
    python -c "import torch; print(f'✅ torch {torch.__version__} OK')" && \
    python -c "import pyannote.database; print('✅ pyannote.database OK')" && \
    python -c "import pyannote.metrics; print('✅ pyannote.metrics OK')" && \
    python -c "from pyannote.audio import Pipeline; print('✅ pyannote.audio Pipeline OK')" && \
    python -c "import pyannote.audio; print('✅ pyannote.audio OK')" && \
    python -c "import pytorch_lightning; print('✅ pytorch_lightning OK')" && \
    python -c "import scenedetect; from scenedetect import VideoManager; print('✅ scenedetect OK')" && \
    python -c "import whisper; print('✅ whisper OK')" && \
    echo "✅ Critical Python dependencies verified"

# Copy application code
COPY src/ ${LAMBDA_TASK_ROOT}/src/
COPY config/ ${LAMBDA_TASK_ROOT}/config/

# Create lambda handler entry point
# The handler function is in src/workers/lambda_handler.py
# AWS Lambda will look for lambda_function.lambda_handler by default
COPY lambda_handler_processor.py ${LAMBDA_TASK_ROOT}/lambda_function.py

# Verify processor import works (catches circular imports)
RUN set -e && \
    python -c "from lambda_function import lambda_handler; print('processor import ok')" && \
    echo "✅ Processor import verified successfully"

# Set the CMD to your handler (AWS Lambda base image expects this format)
CMD [ "lambda_function.lambda_handler" ]
