# Dockerfile for API Lambda Function
# Uses AWS Lambda Python base image for compatibility.
#
# Dependencies used by API: pydantic, pydantic-settings, python-dotenv, boto3, numpy;
#   fastapi, uvicorn, mangum, httpx, python-multipart;
#   openai, pinecone (faiss-cpu omitted; use Pinecone for Lambda).

FROM public.ecr.aws/lambda/python:3.11

# Use set -e to fail on any error
RUN set -e && \
    pip install --no-cache-dir --upgrade pip setuptools wheel

# Install API dependencies with pinned versions (pre-built wheels only)
# Pin versions that have pre-built wheels for Lambda's architecture
RUN set -e && \
    pip install --no-cache-dir \
    "pydantic==2.5.3" \
    "pydantic-settings==2.1.0" \
    "pydantic-core==2.14.6" \
    "python-dotenv==1.0.0" \
    "boto3==1.34.0" \
    "numpy==1.24.3"

# Install FastAPI and ASGI dependencies
RUN set -e && \
    pip install --no-cache-dir \
    "fastapi==0.109.0" \
    "uvicorn[standard]==0.27.0" \
    "mangum==0.17.0" \
    "httpx==0.26.0" \
    "python-multipart==0.0.6"

# Install vector store and embeddings (for query endpoint)
# Used by: query (semantic_search, create_vector_store, OpenAIEmbeddingModel).
# faiss-cpu omitted (numpy>=1.25 conflict); use Pinecone for Lambda.
RUN set -e && \
    pip install --no-cache-dir \
    "openai==1.12.0" \
    "pinecone==5.0.1"

# Verify critical dependencies are installed
RUN set -e && \
    python -c "import pydantic; print('✅ pydantic OK')" && \
    python -c "import pydantic_core; print('✅ pydantic_core OK')" && \
    python -c "import fastapi; print('✅ fastapi OK')" && \
    python -c "import mangum; print('✅ mangum OK')" && \
    python -c "import boto3; print('✅ boto3 OK')" && \
    python -c "import numpy; print('✅ numpy OK')" && \
    python -c "import openai; print('✅ openai OK')" && \
    python -c "import pinecone; print('✅ pinecone OK')" && \
    echo "✅ All API dependencies verified successfully"

# Copy application code
COPY src/ ${LAMBDA_TASK_ROOT}/src/
COPY config/ ${LAMBDA_TASK_ROOT}/config/

# Create lambda handler entry point
# The handler function is in src/api/lambda_handler.py
# AWS Lambda will look for lambda_function.lambda_handler by default
COPY lambda_handler_api.py ${LAMBDA_TASK_ROOT}/lambda_function.py

# Set the CMD to your handler (AWS Lambda base image expects this format)
CMD [ "lambda_function.lambda_handler" ]
